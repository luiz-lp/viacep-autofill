<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Exemplo ViaCEP Autofill v1.3.0</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    input, select { display: block; margin: 0.5rem 0; padding: 0.5rem; width: 220px; }
    .loading { color: blue; }
    .error { color: red; }
    .success { color: green; }
  </style>
</head>
<body>
  <h1>Teste ViaCEP Autofill v1.3.0</h1>

  <form id="form-endereco">
    <input id="cep" placeholder="CEP" />
    <input id="rua" data-viacep="logradouro" placeholder="Rua" />
    <input id="bairro" data-viacep="bairro" placeholder="Bairro" />
    <input id="cidade" data-viacep="localidade" placeholder="Cidade" />
    <select id="uf" data-viacep="uf">
      <option value="">UF</option>
      <option>SP</option><option>RJ</option><option>MG</option><option>ES</option>
    </select>
    <!-- hidden s√≥ pra demonstrar transform -->
    <input type="hidden" id="cep-hidden" name="cepSemMascara" />
  </form>

  <p id="status"></p>

  <script src="../dist/viacep-autofill.global.js"></script>
  <script>
    const statusEl = document.getElementById('status');

    ViaCepAutofill.init({
      root: '#form-endereco',     // novo: limita auto-map a este form
      cep: '#cep',
      validateOnBlur: true,
      fetchTimeout: 6000,
      retries: 2,
      retryBackoffBase: 300,
      fallback: true,

      // cache configurado
      cache: 'localStorage',      // 'memory' | 'localStorage' | false
      cacheTTL: 300000,           // 5 minutos

      // UF select
      addUfIfMissing: true,       // cria a option se n√£o existir

      // transforma√ß√£o antes de preencher
      transform(data) {
        const out = { ...data };
        if (out.logradouro) {
          out.logradouro = out.logradouro
            .replace(/\s+/g, ' ')
            .toLowerCase()
            .replace(/^\w/g, c => c.toUpperCase());
        }
        // Exemplo: salvar CEP sem m√°scara em hidden
        const hidden = document.querySelector('#cep-hidden');
        if (hidden) hidden.value = (out.cep || '').replace(/\D+/g, '');
        return out;
      },

      onStateChange: (state, payload) => {
        if (state === 'FETCHING') {
          statusEl.textContent = 'üîÑ Buscando informa√ß√µes do CEP...';
          statusEl.className = 'loading';
        }
        if (state === 'SUCCESS') {
          statusEl.textContent = '‚úÖ Endere√ßo preenchido com sucesso!';
          statusEl.className = 'success';
        }
        if (state === 'NOT_FOUND') {
          statusEl.textContent = '‚ùå CEP n√£o encontrado.';
          statusEl.className = 'error';
        }
      },

      onError: (err) => {
        if (err.code === 'CANCELED' || err.name === 'AbortError') return; // silencia
        const map = {
          INVALID_CEP: 'CEP inv√°lido. Use 8 d√≠gitos.',
          TIMEOUT: 'Tempo de resposta excedido.',
          RATE_LIMITED: 'Muitas consultas. Aguarde alguns segundos.',
          NETWORK: 'Falha de rede. Tente novamente.',
          PROVIDER: 'Erro no servi√ßo de CEP. Tente mais tarde.'
        };
        alert(map[err.code] || err.message || 'Erro inesperado');
        statusEl.textContent = map[err.code] || err.message || 'Erro inesperado';
        statusEl.className = 'error';
      }
    });
  </script>
</body>
</html>
